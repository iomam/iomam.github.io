
<!DOCTYPE html>
<html>
  <head>
<script async src="https://api.glia.com/salemove_integration.js"></script>
<script>
    function findQueuingInstructionsElement() { return document.querySelector('div.instructions') }
    
    function findQueueElement(queueName) { return document.querySelector("div.queue[queue_name='" + queueName + "']") }
    
    function findAllQueueElements() { return document.querySelectorAll('div.queue') }
    
    function findAllQueueMediaButtons() { return document.querySelectorAll('div.queue > .media_button') }
    
    function findMediaButtonsForQueue(queueElement) { return queueElement.querySelectorAll('.media_button') }
    
    function findCancelButton() { return document.querySelector('.cancel') }
    
    function getMediaButtonQueueName(button) { return button.parentElement.getAttribute('queue_name') }
    
    function getButtonMedium(button) { return button.getAttribute('medium') }
        
    function show(element) { element.style.display = 'block' }
    
    function showCanQueue(queueElement, queueMedias) {
        queueElement.classList.remove('disabled');
        updateQueueAvailableMedia(queueElement, queueMedias)
    }
    
    function showCannotQueue(queueElement) {
        queueElement.classList.add('disabled');
        updateQueueAvailableMedia(queueElement, [])
    }
    
    function showCannotQueueAnywhere() { findAllQueueElements().forEach(showCannotQueue) }
    
    function showFailedToQueueView(error) {}
    
    function showCanQueueView() {
        findQueuingInstructionsElement().innerText = '';
        hide(document.querySelector('div.instructions-container'))
    }
    
    function showAlreadyQueuedView() {
        findQueuingInstructionsElement().innerText = 'Please wait, you will be connected shortly';
        show(document.querySelector('div.instructions-container'))
    }
    
    function showCannotQueueView() {}
    
    function updateQueueAvailableMedia(queueElement, medias) {
        findMediaButtonsForQueue(queueElement).forEach(function(button) {
            var mediaUnavailable = medias.indexOf(getButtonMedium(button)) === -1;
            if (mediaUnavailable) {
                button.classList.add('disabled')
            } else {
                button.classList.remove('disabled')
            }
        })
    }
    var queueTicket;
    
    // Bind clicks on queue buttons with Glia SDK
    function listenForQueueButtonClicks(salemove, queues) {
        findAllQueueMediaButtons().forEach(function(mediaButton) {
            // Gather properties from UI element
            var buttonQueueName = getMediaButtonQueueName(mediaButton);
            var buttonMedium = getButtonMedium(mediaButton);
            // Find queue ID by matching the queue name to button queue name
            var queueId = queues
                .filter(function(queue) {
                    return queue.name === buttonQueueName;
                })
                .map(function(queue) {
                    return queue.id;
                })[0];
    
            if (queueId === undefined) {
                throw new Error(
                    'Queue button present, but queue not defined in Glia. Queue name: ' +
                    buttonQueueName
                );
            }
    
            // Queue upon button click
            mediaButton.addEventListener('click', function () {
                if (buttonMedium === 'phone') {
                    // check if the phone number text box is present and if the button is enabled
                    if (document.getElementById('phoneNumberTextBox') == null && !mediaButton.classList.contains("disabled")) {
                        // text box element for the input with styling
                        textBox = document.createElement("input");
                        textBox.setAttribute("type", "text");
                        textBox.setAttribute("id", "phoneNumberTextBox");
                        textBox.classList.add("form-control", "input-md");
                        textBox.style.marginTop = "10px";
                        // submit button element to trigger the engagement request with styling
                        submitButton = document.createElement("button");
                        submitButton.setAttribute("id", "phoneNumberSubmitButton");
                        submitButton.textContent = "Click here to engage";
                        submitButton.classList.add("btn", "btn-default");
                        document.getElementById("testAppend").textContent = "";
                        // div element for the created elements
                        buttonAddOn = document.createElement("div");
                        buttonAddOn.innerHTML += 'Please insert your number:';
                        buttonAddOn.style.color = "#000000";
                        buttonAddOn.appendChild(textBox);
                        buttonAddOn.appendChild(submitButton);
                        // disable the button element and add the div inside the button element
                        document.getElementById("testAppend").disabled = true;
                        document.getElementById("testAppend").appendChild(buttonAddOn);
                        document.getElementById("phoneNumberTextBox").focus();
                        submitButton.addEventListener("click", function (e) {
                            // stop the onClick interaction of the parent element
                            e.stopPropagation();
                            e.preventDefault();

                            // create a variable of the phone number from the text box
                            var phone_number = document.getElementById("phoneNumberTextBox").value;

                            // Remove phone error handling
                            $('.phone_tip').remove();

                            // Remove all non-numeric characters
                            phone_number = phone_number.replace(/\D/g, '');

                            // Validate min-length
                            if (phone_number.length < 10) {
                                let phone_tip = document.createElement("div");
                                phone_tip.classList.add('phone_tip');
                                phone_tip.innerHTML += 'Please enter a valid number.';
                                phone_tip.style.color = "#000000";
                                document.getElementById("testAppend").appendChild(phone_tip);

                                return;
                            }

                            // Validate max-length
                            if (phone_number.length > 11) {
                                let phone_tip = document.createElement("div");
                                phone_tip.classList.add('phone_tip');
                                phone_tip.innerHTML += 'Please enter a valid number.';
                                phone_tip.style.color = "#000000";
                                document.getElementById("testAppend").appendChild(phone_tip);

                                return;
                            }

                            // Add US phone designation if needed
                            if (phone_number.length == 10) {
                                phone_number = `+1${phone_number}`;
                            }

                            // Add country designator if needed
                            if (phone_number.length == 11) {
                                phone_number = `+${phone_number}`;
                            }

                            // trigger the engagement request and set the phone button values back to the original state
                            document.getElementById("testAppend").removeChild(buttonAddOn);
                            document.getElementById("testAppend").disabled = false;
                            document.getElementById("testAppend").textContent = "Have a representative call you directly";
                            salemove
                                .queueForEngagement(buttonMedium, {
                                    queueId: queueId,
                                    phoneNumber: phone_number
                                }).catch(showFailedToQueueView);

                        });
                    }
                } else {
                    salemove
                        .queueForEngagement(buttonMedium, { queueId: queueId })
                        .catch(showFailedToQueueView);
                }
            });
        });
    }
    
    function listenForCancel() { findCancelButton().addEventListener('click', function() { if (queueTicket) { queueTicket.cancel() } else { throw new Error('Cannot cancel queuing while not queued') } }) }
    
    function onQueueState(queue) {
        if (findQueueElement(queue.name) !== null) {
    
            console.log('checking queue status', queue.state.status, queue.state.STATUSES.OPEN);
    
            if (queue.state.status === queue.state.STATUSES.OPEN) {
                showCanQueue(findQueueElement(queue.name), queue.state.medias)
            } else {
                showCannotQueue(findQueueElement(queue.name))
            }
        }
    }
    
    function onVisitorQueueingState(queuingState) {
        if (queuingState.state === queuingState.QUEUE_STATES.QUEUED) {
            queueTicket = queuingState.ticket;
            findAllQueueElements().forEach(hide);
            show(findCancelButton());
            showAlreadyQueuedView()
        } else if (queuingState.state === queuingState.QUEUE_STATES.CANNOT_QUEUE) {
            queueTicket = null;
            hide(findCancelButton());
            showCannotQueueView()
        } else {
            queueTicket = null;
            findAllQueueElements().forEach(show);
            hide(findCancelButton());
            showCanQueueView()
        }
    }
    showCannotQueueAnywhere();
    
    function checkGliaAvailable() {
        gliaAttemptCount++;
        if (gliaAttemptCount > 60) {
            clearInterval(gliaInterval);
            console.log('Timeout waiting for Glia to initialize.');
        }
        if (typeof sm !== 'undefined') {
            clearInterval(gliaInterval);
    
            if (window.location.host.indexOf('qnbtrust.bank') > -1 || window.location.host.indexOf('localhost') > -1) {
                sm.getApi({ version: 'v1' }).then(function(salemove) {
                    salemove.addEventListener(salemove.EVENTS.QUEUE_STATE_UPDATE, onVisitorQueueingState);
                    listenForCancel();
                    salemove.getQueues().then(function(queues) {
                        listenForQueueButtonClicks(salemove, queues);
                        var queueIds = queues.map(function(queue) { return queue.id });
                        salemove.subscribeToQueueStateUpdates(queueIds, onQueueState)
                    })
                })
            }
        }
    }
    var gliaAttemptCount = 0;
    var gliaInterval = setInterval(checkGliaAvailable, 500);
    </script>
  </head>
<body style="background-color:pink;">

</div>
<h1>My First Heading</h1>
<p>My first paragraph.</p>
<a data-sm-show-media-selection-on="click" href="javascript:void(0);"> Contact Us </a>
</div>    
    <br>
    
 <br>
 <br>

 <a href="https://erxxmoves.tumblr.com/">Different domain</a>

<div>
  <div class="instructions"></div>
  <div class="queue" queue_name="Default Queue">
    <span> Need help with the product? </span>
    <button class="media_button" medium="text">Chat using your browser</button>
    <button class="media_button" medium="phone">
      Speak using your computer microphone
    </button>
    <button class="media_button" medium="phone">Speak using your phone</button>
    <button class="media_button" medium="video">
      Speak using your computer camera and microphone
    </button>
    <button class="cancel">Leave queue</button>
  </div>

</body>
</html>
